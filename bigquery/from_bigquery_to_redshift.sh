export GOOGLE_APPLICATION_CREDENTIALS=/var/www/html/data-management-platform/bigquery/service_account.json
export GOOGLE_CLOUD_PROJECT=lmn-martech-dashb-affiliation
PGPASSWORD=mq8Ynmu4VDhxQMckPY*q psql -h 52.29.124.37 -U nkolster -d lmn -p 5439 -c "DROP VIEW affiliatedata_clean"
/home/web-user/google-cloud-sdk/bin/bq extract --destination_format=CSV affiliation.costs_and_margins gs://affiliation-data/bigquery.csv
/home/web-user/google-cloud-sdk/bin/gsutil cp gs://affiliation-data/bigquery.csv /var/www/html/data-management-platform/bigquery/
/home/web-user/.embulk/bin/embulk run /var/www/html/data-management-platform/bigquery/bigquery.yml
PGPASSWORD=mq8Ynmu4VDhxQMckPY*q psql -h 52.29.124.37 -U nkolster -d lmn -p 5439 -c "CREATE VIEW affiliatedata_clean AS SELECT *, CASE WHEN cpa::text~'^[0-9.]+$'::character varying::text THEN cpa::numeric::numeric(18, 0)::numeric(18, 6) ELSE 0::numeric::numeric(18, 0) END AS cpa_num, CASE WHEN amc4_afs::text~'^[0-9.]+$'::character varying::text THEN amc4_afs::numeric::numeric(18, 0)::numeric(18, 6) ELSE 0::numeric::numeric(18, 0) END AS amc4_afs_num, CASE WHEN bk_value::character varying::text~'^[0-9.]+$'::character varying::text THEN bk_value::numeric(18, 0)::numeric(18, 6) ELSE 0::numeric::numeric(18, 0) END AS bk_value_num, CASE WHEN voucher_amount::text~'^[0-9.]+$'::character varying::text THEN voucher_amount::numeric::numeric(18, 0)::numeric(18, 6) ELSE 0::numeric::numeric(18, 0) END AS voucher_amount_num, product_name AS product, btrim(bk_date::character varying::text)::TIMESTAMP WITHOUT TIME ZONE AS bk_date_ts FROM costs_and_margins_bq WHERE bk_date::character varying::text~~'20%'::character varying::text;"
